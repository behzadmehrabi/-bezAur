import os
import subprocess
import tarfile


import requests
from bs4 import BeautifulSoup


import utils
import caching

class DiffReview:
    def __init__(self, selected_pkg, args):
        self.args = args
        self.name = selected_pkg['name']
        self.version = selected_pkg['version']

        self.base_url = 'https://aur.archlinux.org'
        self.cache_key = 'diff{}{}'.format(self.name, selected_pkg['version'])

        if self._diff_review_confirm():
            self.page_source = caching.cache.get(self.cache_key)
            if not self.page_source:
                self._get_diff_page()
                self.page_source = caching.cache.get(self.cache_key)

            commits = self._get_commits()
            for cc, link in self._find_tarball(commits):
                tar = self._get_tarball(cc, link)
                self._extract_tarball(tar)
            self._show_diff()
    
    def _diff_review_confirm(self):
        if self.args['--diff-review']:
            diff_check = True
        elif self.args['--no-diff-review']:
            diff_check = False
        else:
            text = 'do you want to diff review? [Y/n] '
            answer = utils.get_input(text)
            diff_check = utils.yes_no_checker(answer)

        return diff_check

    def _get_diff_page(self):
        url = '{}/cgit/aur.git/log/.SRCINFO?h={}'.format(self.base_url, self.name)
        response = requests.get(url)
        return caching.cache.set(self.cache_key, response.text)

    def _get_commits(self):
        soup = BeautifulSoup(self.page_source, 'html.parser')
        table = soup.find('table', attrs={'class': 'list nowrap'})
        last_two_commit = table.find_all('tr')[1:3]
        return last_two_commit

    def _find_tarball(self, commits):
        print(utils._cyan('>>>'), 'getting files to review...', sep=' ')
        for commit in commits:
            link = commit.find('a').get('href')
            url = '{}{}'.format(self.base_url, link)
            response = requests.get(url)

            soup = BeautifulSoup(response.text, 'html.parser')
            table = soup.find('table', attrs={'class': 'commit-info'})
            commit_code, link = [(a.text, a.get('href')) for a in table.find_all('a') if a.text.endswith('tar.gz')][0]
            yield commit_code, link

    def _get_tarball(self, cc, link):
        tarpath = '/tmp/bezaur/{}{}'.format(self.name, cc)
        if os.path.exists(tarpath):
            return tarpath
        tarball = requests.get('{}{}'.format(self.base_url, link))
        with open(tarpath, 'wb') as tf:
            tf.write(tarball.content)
            return tf.name
    
    def _extract_tarball(self, tar):
        with tarfile.open(tar, "r:gz") as tf:
                 def is_within_directory(directory, target):
                     
                     abs_directory = os.path.abspath(directory)
                     abs_target = os.path.abspath(target)
                 
                     prefix = os.path.commonprefix([abs_directory, abs_target])
                     
                     return prefix == abs_directory
                 
                 def safe_extract(tar, path=".", members=None, *, numeric_owner=False):
                 
                     for member in tar.getmembers():
                         member_path = os.path.join(path, member.name)
                         if not is_within_directory(path, member_path):
                             raise Exception("Attempted Path Traversal in Tar File")
                 
                     tar.extractall(path, members, numeric_owner=numeric_owner) 
                     
                 
                 safe_extract(tf, path="/tmp/bezaur/")

    def _show_diff(self):
        first = utils.abs_path('/tmp/bezaur/aur-4369b2d562ca5a526c9e5d96df5949cb51f9cd6f/')
        second = utils.abs_path('/tmp/bezaur/aur-f380837df5229c7196d7d9805b06795033b1f5cf')

        diff_file = '/tmp/bezaur/{}{}diffreview.txt'.format(self.name, self.version)
        return_code = subprocess.call(['less', diff_file])
        if return_code != 0:
            with open(diff_file, 'w+') as f:
                for file1, file2 in zip(first, second):
                    subprocess.call(['diff', file1, file2, '--color=always', '--unified'], stdout=f)
                    subprocess.call(['echo', '\n'], stdout=f)
                subprocess.call(['less', diff_file])

